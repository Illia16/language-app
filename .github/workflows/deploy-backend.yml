name: Deploy Backend
run-name: ${{ github.actor }} is deploying backend (AWS)  ðŸš€
on:
  push:
    branches:
      - deploy/*
jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
  
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set Environment Name
        id: set-env
        run: echo "ENV_NAME=${GITHUB_REF#refs/heads/deploy/}" >> $GITHUB_ENV

      - name: Install CDK Dependencies
        run: npm install
        working-directory: backend_cdk

      - name: Install Lambda Function Dependencies
        run: npm install
        working-directory: backend_cdk/lib/functions

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "us-east-1"

      - name: Deploy CloudFormation Template
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          OPEN_AI_KEY: ${{ secrets.OPEN_AI_KEY }}
          SQS_URL_TEST: ${{ secrets.SQS_URL_TEST }}
          SQS_URL_PROD: ${{ secrets.SQS_URL_PROD }}
        run: npx cdk deploy -c env=${{ env.ENV_NAME }}
        working-directory: backend_cdk

      - name: Repository Dispatch
        if: ${{ success() }}
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: deploy-backend
          client-payload: '{"env": "${{ env.ENV_NAME }}"}'
